import useBaseUrl from '@docusaurus/useBaseUrl';

# UAT, RomÃ¢nia (poligon)

## Cod set de date

**`ro_admin_lau_polygon`**

<figure style={{ textAlign: "center" }}>
  <img src={useBaseUrl('https://services.geo-spatial.org/data/thumbnails/administrative-boundaries/lau/ro-admin-lau-polygon.svg')} alt="Limite administrative - UAT, RomÃ¢nia (poligon)" />
</figure>

## Abordare practicÄƒ

Limitele unitÄƒÈ›ilor administrativ teritoriale (UAT) din RomÃ¢nia, format vectorial/poligon, au fost descÄƒrcate de pe [geoportalul ANCPI](https://geoportal.ancpi.ro/portal/apps/webappviewer/index.html?id=faeba2d173374445b1f13512bd477bb2) Ã®n format Shapefile. Ulterior, au fost trecute printr-o procedurÄƒ automatÄƒ de procesare folosind un script (Bash - mediu *nix) ce este rulat dupÄƒ fiecare actualizare a datelor de la ANCPI. Pentru paÈ™ii de procesare, scriptul utilizeazÄƒ mai multe biblioteci open source È™i utilitare de sistem: [GDAL](https://gdal.org), [mapshaper](https://mapshaper.org/), [csvkit](https://csvkit.readthedocs.io/en/latest/), [mdb-tools](https://mdbtools.github.io/), [sed](https://www.gnu.org/software/sed/manual/sed.html), [awk](https://www.gnu.org/software/gawk/manual/gawk.html). Scriptul rezultat este prezentat Ã®n secÈ›iunea [Script ETL](#script-etl) È™i accesibil pentru descÄƒrcare pe pagina GitHub a geo-spatial.org.

## Prelucrarea datelor

### Definirea corectÄƒ a proiecÈ›iei

Datele au venit cu o definiÈ›ie nestandardizatÄƒ a proiecÈ›iei:

>PROJCRS["Romania_double_stereo",BASEGEOGCRS["Pulkovo 1942",DATUM["Pulkovo 1942",ELLIPSOID["Krassowsky 1940",6378245,298.3,LENGTHUNIT["metre",1]],ID["EPSG",6284]],PRIMEM["Greenwich",0,ANGLEUNIT["Degree",0.0174532925199433]]],CONVERSION["unnamed",METHOD["Oblique Stereographic",ID["EPSG",9809]],PARAMETER["Latitude of natural origin",46,ANGLEUNIT["Degree",0.0174532925199433],ID["EPSG",8801]],PARAMETER["Longitude of natural origin",25,ANGLEUNIT["Degree",0.0174532925199433],ID["EPSG",8802]],PARAMETER["Scale factor at natural origin",0.99975,SCALEUNIT["unity",1],ID["EPSG",8805]],PARAMETER["False easting",500000,LENGTHUNIT["metre",1],ID["EPSG",8806]],PARAMETER["False northing",500000,LENGTHUNIT["metre",1],ID["EPSG",8807]]],CS[Cartesian,2],AXIS["(E)",east,ORDER[1],LENGTHUNIT["metre",1,ID["EPSG",9001]]],AXIS["(N)",north,ORDER[2],LENGTHUNIT["metre",1,ID["EPSG",9001]]]]

Aceasta a fost Ã®nlocuitÄƒ cu [EPSG:3844](https://epsg.io/3844).

### Eliminarea cÃ¢mpurilor cu informaÈ›ie redundantÄƒ

O serie din cÃ¢mpuri au fost considerate neimportante pentru utilizatorul obiÈ™nuit: `IFCID`, `localId`, `namespace`, `country`, `versionId`, `resOfOut`, `endVersion`, `Shape_Leng`, `ShapeArea`. Aceste cÃ¢mpuri, cum ar fi `namespace`, pot avea importanÈ›a lor Ã®n demersuri precum Directiva INSPIRE dar, din punct de vedere practic, cÃ¢nd nu sunt exploatate Ã®ntr-un context de interoperabilitate cu date la nivel european, dar care, altfel, doar Ã®ncarcÄƒ inutil setul de date (au aceeaÈ™i valoare pentru toate entitÄƒÈ›ile din setul de date).

### AdÄƒugarea de cÃ¢mpuri noi

Din nomenclatorul [SIRUTA](http://80.96.186.4:81/senin/classifications.htm), publicat de [Institutul NaÈ›ional de StatisticÄƒ](https://insse.ro), au fost adÄƒugate o serie de cÃ¢mpuri suplimentare:

* `countyId` - codul numeric al judeÈ›ului;
* `countyCode` - codul SIRUTA al judeÈ›ului;
* `county` - numele judeÈ›ului;
* `countyMn` - abrevierea judeÈ›ului;
* `regionId` - codul numeric a regiunii de dezvoltare;
* `regionCode` - codul SIRUTA a regiunii de dezvoltare;
* `region` - numele regiunii de dezvoltare.

### Formatarea denumirii UAT-urilor È™i corectarea diacriticelor

AtÃ¢t Ã®n fiÈ™ierul Shapefile publicat de ANCPI, cÃ¢t È™i Ã®n nomenclatorul SIRUTA, denumirile UAT-urilor au douÄƒ probleme importante:

* Sunt scrise cu majuscule
* O parte din diacritice sunt greÈ™ite (`ÅŸ` Ã®n loc de `È™`; `Å£` Ã®n loc de `È›`; `Ã£` Ã®n loc de `Äƒ`').

Ambele au fost corectate.

<figure style={{ textAlign: "center" }}>
  <img src={useBaseUrl('/img/ghiduri/procesari-etl/administrative-boundaries/corectare-denumiri-uat.jpg')} alt="Exemplu: denumirea de intrare a UAT-urilor (stÃ¢nga) È™i rezultatul final (dreapta)" />
  <figcaption><em>Exemplu: denumirea de intrare a UAT-urilor (stÃ¢nga) È™i rezultatul final (dreapta).</em></figcaption>
</figure>

### Conversia Ã®n formate de fiÈ™ier populare

Datele au foct convertite Ã®n formatele de fiÈ™ier utilizate de geo-spatial.org pentru distribuirea de date vectoriale: `GeoPackage`, `Shapefile`, `Geoparquet`, `FlatGeobuf`, `GeoJSON`, `TopoJSON`, `KML`. Detalii despre motivaÈ›ia alegerii acestor formate È™i beneficiile fiecÄƒruia sunt prezentate Ã®n ghidul cu privire la date. De asemenea, pentru nevoi interne, datele au fost Ã®ncÄƒrcate Ã®n baza de date PostgreSQL/PostGIS.

### Publicare datelor

Datele au fost documentate Ã®n [Catalogul geo-spatial.org](https://services.geo-spatial.org/geonetwork/srv/eng/catalog.search#/metadata/5d90a442-0659-4ad9-9af1-9b890b2ff0c8) È™i puse la dispoziÈ›ie pentru download/access prin protocolul HTTP È™i prin intermediul serviciilor standardizate OGC. Pentru mai multe detalii accesaÈ›i [Catalogul](https://services.geo-spatial.org/geonetwork/srv/eng/catalog.search#/metadata/5d90a442-0659-4ad9-9af1-9b890b2ff0c8) È™i/sau secÈ›iunea <a href={useBaseUrl('descarcare/date/administrative-boundaries')}>DescÄƒrcare</a>.

## Script ETL

```bash title="procesare_limite_uat.sh"
#!/usr/bin/zsh

# Activarea profilului Anaconda cu utilitare software instalate
source /home/ubuntu/anaconda3/etc/profile.d/conda.sh
conda activate geo

insDataPath="/data/ins/siruta"
ancpiDataPath="/data/ancpi/limite_administrative"
lauDataPath="/data/output/administrative_boundaries/lau"
tmpDataPath="/data/tmp"

echo "
ğŸ›  Procesare UAT poligon
 "

echo "ğŸ’¾ ÃncÄƒrcare date Ã®n SQLite"

#ğŸ’¾ Ã®ncÄƒrcare SHP ANCPI Ã®n SQLite
ogr2ogr  -of "SQLite" -a_srs "EPSG:3844" -lco LAUNDER=NO ${tmpDataPath}/uat.db ${ancpiDataPath}/Unitate_administrativa_UAT.shp

#ğŸ’¾ Ã®ncÄƒrcare tabel regiuni de dezvoltare Ã®n SQLite
csvsql --db sqlite:///${tmpDataPath}/uat.db --insert ${insDataPath}/siruta_zone.csv

#ğŸ’¾ Ã®ncÄƒrcare tabel judeÈ›e Ã®n SQLite
csvsql --db sqlite:///${tmpDataPath}/uat.db --insert ${insDataPath}/siruta_judete.csv

#ğŸ’¾ conversie MDB Ã®n CSV
mdb-export ${insDataPath}/siruta.mdb siruta_rez > ${tmpDataPath}/siruta.csv

#ğŸ’¾ formatare CSV: se eliminÄƒ cÃ¢mpurile nerelevante (FSJ, FS2, FS3, fictiv); se formateazÄƒ cÃ¢mpurile de tip text ca "lowercase"; se convertesc cÃ¢mpurile SIRUTA, CODP È™i SIRSUP din notarea È™tiinÈ›ificÄƒ Ã®n format integer
awk -F, 'BEGIN{printf("%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s\n","siruta","denloc","codp","jud","sirsup","tip","niv","med","regiune","fsl", "rang")} NR>1{printf("%.0f,%s,%.0f,%d,%.0f,%d,%d,%s,%d,%s,%s\n",$1,tolower($2),$3,$4,$5,$6,$7,$8,$9,$13,$14)}' ${tmpDataPath}/siruta.csv > ${tmpDataPath}/siruta_corectat.csv

#ğŸ’¾ Ã®nlocuire diacritice incorecte ("È™" È™i "È›" din sedilÄƒ Ã®n virgulÄƒ; se corecteazÄƒ "Äƒ")
sed -i -e 's/ÅŸ/È™/g' -e 's/Å£/È›/g' -e 's/Ã£/Äƒ/g' ${tmpDataPath}/siruta_corectat.csv

#ğŸ’¾ conversie cÃ®mpuri de tip text din "lowercase" Ã®n "titlecase" - este exceptat primul rÃ®nd, cel cu numele de coloane
sed -i '2,$s/.*/\L&/; 2,$s/[a-z]*/\u&/g' ${tmpDataPath}/siruta_corectat.csv

#ğŸ’¾ Ã®nlocuire prepoziÈ›ii folosite Ã®n numele de localitÄƒÈ›i din "titlecase" Ã®napoi Ã®n "lowercase"
sed -i -e 's/ De / de /g' -e 's/ Din / din /g' -e 's/ La / la /g' -e 's/ Pe / pe /g' -e 's/ Cu / cu /g' -e 's/ Lui / lui /g' -e 's/ Cel / cel /g' -e 's/ Sub / sub /g' -e 's/ In / Ã®n /g' -e 's/ ii/ II/g' -e 's/Municipiul //g' -e 's/OraÈ™ //g' ${tmpDataPath}/siruta_corectat.csv

#ğŸ’¾ Ã®ncÄƒrcare tabel SIRUTA Ã®n SQLITE
csvsql --db sqlite:///${tmpDataPath}/uat.db --insert ${tmpDataPath}/siruta_corectat.csv

ogr2ogr -of "SQLite" -append -dsco SPATIALITE=YES -lco LAUNDER=NO -a_srs EPSG:3844 -nln ro_admin_lau_polygon -sql "SELECT CAST(a.natCode AS INTEGER) AS natCode, b.denloc AS name, a.natLevName AS natLevName, CAST(c.jud AS INTEGER) AS countyId, CAST(c.siruta AS INTEGER) AS countyCode, c.denj AS county, c.mnemonic AS countyMn, CAST(d.zona AS INTEGER) AS regionId, CAST(d.siruta AS INTEGER) AS regionCode, d.denzona AS region, a.beginvers AS version, a.GEOMETRY FROM Unitate_administrativa_UAT AS a LEFT JOIN siruta_corectat AS b ON (a.natcode = b.siruta) LEFT JOIN siruta_judete AS c ON (c.jud=b.jud) LEFT JOIN siruta_zone AS d ON (c.zona=d.zona)" ${tmpDataPath}/uat.db ${tmpDataPath}/uat.db

#ğŸ’¾ creare versiune GeoPackage
echo "ğŸ’¾ creare versiune GeoPackage"
if [ -f ${lauDataPath}/ro_admin_lau_polygon.gpkg ]; then
    rm ${lauDataPath}/ro_admin_lau_polygon.gpkg
fi
ogr2ogr -of GPKG -lco FID=id -a_srs EPSG:3844 -nln ro_admin_lau_polygon -dialect sqlite -sql "SELECT GEOMETRY AS geometry, * FROM ro_admin_lau_polygon" ${lauDataPath}/ro_admin_lau_polygon.gpkg ${tmpDataPath}/uat.db

#ğŸ’¾ creare fiÈ™iere Esri Shapefile
echo "ğŸ’¾ creare fiÈ™iere Esri Shapefile"
if [ -f ${lauDataPath}/ro_admin_lau_polygon.zip ]; then
    rm ${lauDataPath}/ro_admin_lau_polygon.zip
fi
ogr2ogr -lco ENCODING=UTF-8 -nln ro_admin_lau_polygon -dialect sqlite -sql "SELECT a.id AS id, * FROM ro_admin_lau_polygon AS a" ${lauDataPath}/ro_admin_lau_polygon.shp ${lauDataPath}/ro_admin_lau_polygon.gpkg

#ğŸ“¦ arhivare fiÈ™iere shp
echo "ğŸ“¦ arhivare fiÈ™iere shp"
zip -j ${lauDataPath}/ro_admin_lau_polygon.zip ${lauDataPath}/ro_admin_lau_polygon.dbf ${lauDataPath}/ro_admin_lau_polygon.shp ${lauDataPath}/ro_admin_lau_polygon.prj ${lauDataPath}/ro_admin_lau_polygon.shx ${lauDataPath}/ro_admin_lau_polygon.cpg

#ğŸ’¾ creare versiune FlatGeobuf
echo "ğŸ’¾ creare versiune FlatGeobuf"
if [ -f ${lauDataPath}/ro_admin_lau_polygon.fgb ]; then
    rm ${lauDataPath}/ro_admin_lau_polygon.fgb
fi
ogr2ogr -of FlatGeobuf -nlt MULTIPOLYGON -nln ro_admin_lau_polygon -dialect sqlite -sql "SELECT a.id AS id, * FROM ro_admin_lau_polygon AS a" ${lauDataPath}/ro_admin_lau_polygon.fgb ${lauDataPath}/ro_admin_lau_polygon.gpkg

#ğŸ’¾ creare versiune GeoParquet
echo "ğŸ’¾ creare versiune GeoParquet"
if [ -f ${lauDataPath}/ro_admin_lau_polygon.parquet ]; then
    rm ${lauDataPath}/ro_admin_lau_polygon.parquet
fi
ogr2ogr -of Parquet -nlt MULTIPOLYGON -nln ro_admin_lau_polygon -dialect sqlite -sql "SELECT a.id AS id, * FROM ro_admin_lau_polygon AS a" ${lauDataPath}/ro_admin_lau_polygon.parquet ${lauDataPath}/ro_admin_lau_polygon.gpkg

#ğŸ’¾ creare versiune GeoJSON
echo "ğŸ’¾ creare versiune GeoJSON"
if [ -f ${lauDataPath}/ro_admin_lau_polygon.geojson ]; then
    rm ${lauDataPath}/ro_admin_lau_polygon.geojson
fi
ogr2ogr -of GeoJSON -t_srs EPSG:4326 -nln ro_admin_lau_polygon -dialect sqlite -sql "SELECT a.id AS id, * FROM ro_admin_lau_polygon AS a" ${lauDataPath}/ro_admin_lau_polygon.geojson ${lauDataPath}/ro_admin_lau_polygon.gpkg

#ğŸ’¾ creare versiune KML
echo "ğŸ’¾ creare versiune KML"
if [ -f ${lauDataPath}/ro_admin_lau_polygon.kml ]; then
    rm ${lauDataPath}/ro_admin_lau_polygon.kml
fi
ogr2ogr -of KML -t_srs EPSG:4326 -dsco NameField=name ${lauDataPath}/ro_admin_lau_polygon.kml ${lauDataPath}/ro_admin_lau_polygon.gpkg

#ğŸ’¾ creare versiune TopoJSON
echo "ğŸ’¾ creare versiune TopoJSON"
if [ -f ${lauDataPath}/ro_admin_lau_polygon.topojson ]; then
    rm ${lauDataPath}/ro_admin_lau_polygon.topojson
fi
mapshaper -i ${lauDataPath}/ro_admin_lau_polygon.geojson -o format=topojson ${lauDataPath}/ro_admin_lau_polygon.topojson

#ğŸ’¾ actualizarea setului de date Ã®n baza de date PostGIS
echo "ğŸ’¾ actualizarea setului de date Ã®n baza de date PostGIS"
ogr2ogr -of "PostgreSQL" PG:"host=localhost port=5432 user=user dbname=geospatial password=password" -lco schema=romania -lco GEOMETRY_NAME=geom -lco overwrite=yes  -lco LAUNDER=NO -nlt MULTIPOLYGON ${lauDataPath}/ro_admin_lau_polygon.gpkg ro_admin_lau_polygon -skipfailures -overwrite
psql -h localhost -p 5432 -U user -d geospatial -c "
CREATE INDEX ro_admin_lau_polygon_geom_idx ON romania.ro_admin_lau_polygon USING GIST (geom);
CLUSTER romania.ro_admin_lau_polygon USING ro_admin_lau_polygon_geom_idx;"

#ğŸ’¾ actualizarea metadatelor din serviciile de date
echo "ğŸ’¾ actualizarea metadatelor din serviciile de date"
curl -u user:password -XPUT -H "Content-type: text/xml" -d "<featureType><abstract>Limitele unitÄƒÈ›ilor administrativ teritoriale din RomÃ¢nia (poligon). Actualizare 05.05.2025. Sursa ANCPI.</abstract><enabled>true</enabled></featureType>" http://localhost:8080/geoserver/rest/workspaces/limite-administrative/datastores/romania/featuretypes/ro_admin_lau_polygon

#ğŸ—‘ï¸ È˜tergere fiÈ™iere intermediare
echo "ğŸ—‘ï¸ È˜tergere fiÈ™iere Shapefile"
rm ${lauDataPath}/ro_admin_lau_polygon.dbf ${lauDataPath}/ro_admin_lau_polygon.shp ${lauDataPath}/ro_admin_lau_polygon.prj ${lauDataPath}/ro_admin_lau_polygon.shx ${lauDataPath}/ro_admin_lau_polygon.cpg
}
```
