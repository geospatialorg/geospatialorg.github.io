import useBaseUrl from '@docusaurus/useBaseUrl';

# UAT, Rom칙nia  (poligon, geometrie simplificat캒)

## Cod set de date

**`ro_admin_lau_simplified_polygon`**

<figure style={{ textAlign: "center" }}>
  <img src={useBaseUrl('/img/ghiduri/procesari-etl/administrative-boundaries/ro_admin_lau_polygon.svg')} alt="Limite administrative - UAT, Rom칙nia (poligon)" />
</figure>

## Abordare practic캒

Geometria setului de date [Limite administrative - UAT, Rom칙nia (poligon)](ro-admin-lau-polygon) a fost simplificat캒 folosind biblioteca [mapshaper](https://mapshaper.org/):
* Algoritm: `Visvalingam / weighted area`;
* Factor de simplificare: `3%`;

Pentru pa탳ii de procesare, scriptul utilizeaz캒 mai multe biblioteci open source 탳i utilitare de sistem: [GDAL](https://gdal.org), [mapshaper](https://mapshaper.org/), [csvkit](https://csvkit.readthedocs.io/en/latest/), [mdb-tools](https://mdbtools.github.io/), [sed](https://www.gnu.org/software/sed/manual/sed.html), [awk](https://www.gnu.org/software/gawk/manual/gawk.html). Scriptul rezultat este prezentat 칥n sec탵iunea [Script ETL](#script-etl) 탳i accesibil pentru desc캒rcare pe pagina GitHub a geo-spatial.org.

## Prelucrarea datelor

### Definirea corect캒 a proiec탵iei

Datele au venit cu o defini탵ie nestandardizat캒 a proiec탵iei:

>PROJCRS["Romania_double_stereo",BASEGEOGCRS["Pulkovo 1942",DATUM["Pulkovo 1942",ELLIPSOID["Krassowsky 1940",6378245,298.3,LENGTHUNIT["metre",1]],ID["EPSG",6284]],PRIMEM["Greenwich",0,ANGLEUNIT["Degree",0.0174532925199433]]],CONVERSION["unnamed",METHOD["Oblique Stereographic",ID["EPSG",9809]],PARAMETER["Latitude of natural origin",46,ANGLEUNIT["Degree",0.0174532925199433],ID["EPSG",8801]],PARAMETER["Longitude of natural origin",25,ANGLEUNIT["Degree",0.0174532925199433],ID["EPSG",8802]],PARAMETER["Scale factor at natural origin",0.99975,SCALEUNIT["unity",1],ID["EPSG",8805]],PARAMETER["False easting",500000,LENGTHUNIT["metre",1],ID["EPSG",8806]],PARAMETER["False northing",500000,LENGTHUNIT["metre",1],ID["EPSG",8807]]],CS[Cartesian,2],AXIS["(E)",east,ORDER[1],LENGTHUNIT["metre",1,ID["EPSG",9001]]],AXIS["(N)",north,ORDER[2],LENGTHUNIT["metre",1,ID["EPSG",9001]]]]

Aceasta a fost 칥nlocuit캒 cu [EPSG:3844](https://epsg.io/3844).

### Eliminarea c칙mpurilor cu informa탵ie redundant캒

O serie din c칙mpuri au fost considerate neimportante pentru utilizatorul obi탳nuit: `IFCID`, `localId`, `namespace`, `country`, `versionId`, `resOfOut`, `endVersion`, `Shape_Leng`, `ShapeArea`. Aceste c칙mpuri, cum ar fi `namespace`, pot avea importan탵a lor 칥n demersuri precum Directiva INSPIRE dar, din punct de vedere practic, c칙nd nu sunt exploatate 칥ntr-un context de interoperabilitate cu date la nivel european, dar care, altfel, doar 칥ncarc캒 inutil setul de date (au aceea탳i valoare pentru toate entit캒탵ile din setul de date).

### Ad캒ugarea de c칙mpuri noi

Din nomenclatorul [SIRUTA](http://80.96.186.4:81/senin/classifications.htm), publicat de [Institutul Na탵ional de Statistic캒](https://insse.ro), au fost ad캒ugate o serie de c칙mpuri suplimentare:

* `countyId` - codul numeric al jude탵ului;
* `countyCode` - codul SIRUTA al jude탵ului;
* `county` - numele jude탵ului;
* `countyMn` - abrevierea jude탵ului;
* `regionId` - codul numeric a regiunii de dezvoltare;
* `regionCode` - codul SIRUTA a regiunii de dezvoltare;
* `region` - numele regiunii de dezvoltare.

### Formatarea denumirii UAT-urilor 탳i corectarea diacriticelor

At칙t 칥n fi탳ierul Shapefile publicat de ANCPI, c칙t 탳i 칥n nomenclatorul SIRUTA, denumirile UAT-urilor au dou캒 probleme importante:

* Sunt scrise cu majuscule
* O parte din diacritice sunt gre탳ite (`` 칥n loc de `탳`; `콖` 칥n loc de `탵`; `칚` 칥n loc de `캒`').

Ambele au fost corectate.

<figure style={{ textAlign: "center" }}>
  <img src={useBaseUrl('/img/ghiduri/procesari-etl/administrative-boundaries/corectare-denumiri-uat.jpg')} alt="Exemplu: denumirea de intrare a UAT-urilor (st칙nga) 탳i rezultatul final (dreapta)" />
  <figcaption><em>Exemplu: denumirea de intrare a UAT-urilor (st칙nga) 탳i rezultatul final (dreapta).</em></figcaption>
</figure>

### Conversia 칥n formate de fi탳ier populare

Datele au foct convertite 칥n formatele de fi탳ier utilizate de geo-spatial.org pentru distribuirea de date vectoriale: `GeoPackage`, `Shapefile`, `Geoparquet`, `FlatGeobuf`, `GeoJSON`, `TopoJSON`, `KML`. Detalii despre motiva탵ia alegerii acestor formate 탳i beneficiile fiec캒ruia sunt prezentate 칥n ghidul cu privire la date. De asemenea, pentru nevoi interne, datele au fost 칥nc캒rcate 칥n baza de date PostgreSQL/PostGIS.

### Publicare datelor

Datele au fost puse la dispozi탵ie pentru download prin protocolul HTTP:

* [GeoPackage](https://services.geo-spatial.org/data/administrative_boundaries/lau/ro_admin_lau_polygon.gpkg);
* [Shapefile](https://services.geo-spatial.org/data/administrative_boundaries/lau/ro_admin_lau_polygon.zip);
* [Geoparquet](https://services.geo-spatial.org/data/administrative_boundaries/lau/ro_admin_lau_polygon.parquet);
* [FlatGeobuf](https://services.geo-spatial.org/data/administrative_boundaries/lau/ro_admin_lau_polygon.fgb);
* [GeoJSON](https://services.geo-spatial.org/data/administrative_boundaries/lau/ro_admin_lau_polygon.geojson);
* [TopoJSON](https://services.geo-spatial.org/data/administrative_boundaries/lau/ro_admin_lau_polygon.topojson);
* [KLM](https://services.geo-spatial.org/data/administrative_boundaries/lau/ro_admin_lau_polygon.kml).

De asemenea, au fost expune prin intermediul serviciilor standardizate OGC. Stratul poate fi g캒sit sub numele `ro_admin_lau_polygon` 칥n documentele getCapabilities pentru:

* [WMS](https://services.geo-spatial.org/geoserver/limite-administrative/ows?service=WMS&version=1.3.0&request=GetCapabilities);
* [WMTS](https://services.geo-spatial.org/geoserver/limite-administrative/gwc/service/wmts?service=WMTS&version=1.1.1&request=GetCapabilities);
* [WFS](https://services.geo-spatial.org/geoserver/limite-administrative/ows?service=WFS&acceptversions=2.0.0&request=GetCapabilities).

Datele pot fi previzualizate online:

* [Preview simplu (OpenLayers/GeoServer)](https://services.geo-spatial.org/geoserver/limite-administrative/wms?service=WMS&version=1.1.0&request=GetMap&layers=limite-administrative%3Aro_admin_lau_polygon&bbox=134106.265625%2C235541.25%2C870652.0%2C753224.5625&width=768&height=539&srs=EPSG%3A3844&styles=&format=application/openlayers);
* [Aplica탵ie cartografic캒 web](https://services.geo-spatial.org/maps/#/viewer/19)

## Script ETL

```bash title="ro_admin_lau_simplified_polygon.sh"
#!/usr/bin/zsh

# Activarea profilului Anaconda cu utilitare software instalate
source /home/ubuntu/anaconda3/etc/profile.d/conda.sh
conda activate geo

lauDataPath="administrative_boundaries/lau"
tmpDataPath="tmp"

echo "
游 Procesare UAT poligon geometrie simplificat캒
"

#游 creare versiune GeoJSON
echo "游 creare versiune GeoJSON"
if [ -f ${lauDataPath}/ro_admin_lau_simplified_polygon.geojson ]; then
    rm ${lauDataPath}/ro_admin_lau_simplified_polygon.geojson
fi
mapshaper -i ${lauDataPath}/ro_admin_lau_polygon.geojson -simplify 3% keep-shapes -o ${lauDataPath}/ro_admin_lau_simplified_polygon.geojson

#游 creare versiune GeoPackage
echo "游 creare versiune GeoPackage"
if [ -f ${lauDataPath}/ro_admin_lau_simplified_polygon.gpkg ]; then
    rm ${lauDataPath}/ro_admin_lau_simplified_polygon.gpkg
fi
ogr2ogr -of GPKG -s_srs EPSG:4326 -t_srs EPSG:3844 -nln ro_admin_lau_simplified_polygon_int ${lauDataPath}/ro_admin_lau_simplified_polygon_int.gpkg ${lauDataPath}/ro_admin_lau_simplified_polygon.geojson

ogr2ogr -of GPKG -lco FID=id -nln ro_admin_lau_simplified_polygon -dialect sqlite -sql "SELECT geom AS geometry, * FROM ro_admin_lau_simplified_polygon_int" ${lauDataPath}/ro_admin_lau_simplified_polygon.gpkg ${lauDataPath}/ro_admin_lau_simplified_polygon_int.gpkg

#游 creare versiune Esri Shapefile
echo "游 creare versiune Esri Shapefile"
if [ -f ${lauDataPath}/ro_admin_lau_simplified_polygon.zip ]; then
    rm ${lauDataPath}/ro_admin_lau_simplified_polygon.zip
fi
ogr2ogr -lco ENCODING=UTF-8 ${lauDataPath}/ro_admin_lau_simplified_polygon.shp ${lauDataPath}/ro_admin_lau_simplified_polygon.gpkg

#游닍 arhivare versiune shp
echo "游닍 arhivare versiune shp"
zip -j ${lauDataPath}/ro_admin_lau_simplified_polygon.zip ${lauDataPath}/ro_admin_lau_simplified_polygon.dbf ${lauDataPath}/ro_admin_lau_simplified_polygon.shp ${lauDataPath}/ro_admin_lau_simplified_polygon.prj ${lauDataPath}/ro_admin_lau_simplified_polygon.shx ${lauDataPath}/ro_admin_lau_simplified_polygon.cpg

#游 creare versiune FlatGeobuf
echo "游 creare versiune FlatGeobuf"
if [ -f ${lauDataPath}/ro_admin_lau_simplified_polygon.fgb ]; then
    rm ${lauDataPath}/ro_admin_lau_simplified_polygon.fgb
fi
ogr2ogr -of FlatGeobuf -nlt MULTIPOLYGON ${lauDataPath}/ro_admin_lau_simplified_polygon.fgb ${lauDataPath}/ro_admin_lau_simplified_polygon.gpkg

#游 creare versiune GeoParquet
echo "游 creare versiune GeoParquet"
if [ -f ${lauDataPath}/ro_admin_lau_simplified_polygon.parquet ]; then
    rm ${lauDataPath}/ro_admin_lau_simplified_polygon.parquet
fi
ogr2ogr -of Parquet -nlt MULTIPOLYGON ${lauDataPath}/ro_admin_lau_simplified_polygon.parquet ${lauDataPath}/ro_admin_lau_simplified_polygon.gpkg

#游 creare versiune KML
echo "游 creare versiune KML"
if [ -f ${lauDataPath}/ro_admin_lau_simplified_polygon.kml ]; then
    rm ${lauDataPath}/ro_admin_lau_simplified_polygon.kml
fi
ogr2ogr -of KML -t_srs EPSG:4326 -dsco NameField=name ${lauDataPath}/ro_admin_lau_simplified_polygon.kml ${lauDataPath}/ro_admin_lau_simplified_polygon.gpkg

#游 creare versiune TopoJSON
echo "游 creare versiune TopoJSON"
if [ -f ${lauDataPath}/ro_admin_lau_simplified_polygon.topojson ]; then
    rm ${lauDataPath}/ro_admin_lau_simplified_polygon.topojson
fi
mapshaper -i ${lauDataPath}/ro_admin_lau_simplified_polygon.geojson -o format=topojson ${lauDataPath}/ro_admin_lau_simplified_polygon.topojson

#游 actualizarea setului de date 칥n baza de date PostGIS
echo "游 actualizarea setului de date 칥n baza de date PostGIS"
ogr2ogr -of "PostgreSQL" PG:"host=localhost port=5432 user=user dbname=geospatial password=password" -lco schema=romania -lco GEOMETRY_NAME=geom -lco overwrite=yes  -lco LAUNDER=NO -nlt MULTIPOLYGON ${lauDataPath}/ro_admin_lau_simplified_polygon.gpkg ro_admin_lau_simplified_polygon -skipfailures -overwrite
psql -h localhost -p 25432 -U geospatialorg -d geospatial -c "
CREATE INDEX ro_admin_lau_simplified_polygon_geom_idx ON romania.ro_admin_lau_simplified_polygon USING GIST (geom);
CLUSTER romania.ro_admin_lau_simplified_polygon USING ro_admin_lau_simplified_polygon_geom_idx;"

#游 actualizarea metadatelor din serviciile de date
echo "游 actualizarea metadatelor din serviciile de date"
curl -u user:password -XPUT -H "Content-type: text/xml" -d "<featureType><abstract>Limitele unit캒탵ilor administrativ teritoriale din Rom칙nia (poligon, geometrie simplificat캒). Actualizare 26.03.2025. Sursa ANCPI.</abstract><enabled>true</enabled></featureType>" http://localhost:8080/geoserver/rest/workspaces/limite-administrative/datastores/romania/featuretypes/ro_admin_lau_simplified_polygon
```
